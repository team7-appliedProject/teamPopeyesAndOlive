### 전역 변수 설정
@host = http://localhost:8080

###1. 회원가입 테스트
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
"email": "test1@popeye.com",
"password": "qwer@123",
"nickname": "뽀빠이테스터",
"phoneNumber": "01012345678",
"phoneNumberCollectionConsent": true
}

###2. 로그인 테스트 (토큰 발급)
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "email": "test1@popeye.com",
  "password": "qwer@123"
}

> {%
    // 응답 바디의 구조에 따라 경로를 정확히 지정해야 합니다.
    // 현재 구조: { "status": "success", "data": { "accessToken": "...", "tokenType": "Bearer" } }
    if (response.status === 200) {
        client.global.set("auth_token", response.body.data.accessToken);
        client.log("토큰이 성공적으로 저장되었습니다: " + client.global.get("auth_token"));
    }
%}

### 3. 크리에이터 승격 요청
PATCH http://localhost:8080/api/users/me/creator
Authorization: Bearer {{auth_token}}
Content-Type: application/json


###===================U-02 본인 인증 테스트
###1. 인증번호 발송 (U-02)
#휴대폰 번호로 인증번호를 발송합니다. (콘솔 로그에서 인증번호 확인)

POST {{host}}/api/auth/sms/send
Content-Type: application/json

{
  "phoneNumber": "01012345677"
}

###2. 인증번호 검증 (U-02)
#발송된 인증번호를 입력하여 본인 인증을 완료합니다.
#(1번 요청 후 콘솔 로그에서 확인한 인증번호를 code에 입력)

POST {{host}}/api/auth/sms/verify
Content-Type: application/json

{
  "phoneNumber": "01012345677",
  "code": "868480"
}

###===================회원가입2차 (U-01/U-02/U-04)
###1. 회원가입 (U-01/U-02/U-04) - 추천인 코드 없이
#본인 인증 완료 후 가입 시 1000 시금치가 자동 지급되고 추천 코드가 생성됩니다.
#주의: 위의 인증번호 검증이 완료되어야 회원가입이 가능합니다.

POST {{host}}/api/auth/signup
Content-Type: application/json

{
"email": "test3@pp.com",
"password": "qwer@123",
"nickname": "울퉁불퉁",
"phoneNumber": "01012345677",
"phoneNumberCollectionConsent": true
}

###1-1. 회원가입 후 추천 코드 확인
#가입 후 발급된 추천 코드를 확인합니다. (다음 테스트에서 사용)

GET {{host}}/api/users/me
Authorization: Bearer {{auth_token}}

###===================추천인 코드 입력 테스트 (U-01)
###1-2. 추천인 코드 입력 회원가입 (U-01)
#추천인 코드를 입력하여 가입하면 추천인과 신규 가입자 모두에게 500 시금치가 추가 지급됩니다.
#주의: 본인 인증이 완료되어야 하며, 유효한 추천인 코드를 입력해야 합니다.

POST {{host}}/api/auth/sms/send
Content-Type: application/json

{
  "phoneNumber": "01011111111"
}

POST {{host}}/api/auth/sms/verify
Content-Type: application/json

{
  "phoneNumber": "01011111111",
  "code": "인증번호_입력"
}

POST {{host}}/api/auth/signup
Content-Type: application/json

{
"email": "test3@pp.com",
"password": "qwer@123",
"nickname": "추천인코드테스트",
"phoneNumber": "01011111111",
"phoneNumberCollectionConsent": true,
"referralCode": "여기에_위에서_확인한_추천코드_입력"
}

###1-3. 추천인 코드 입력 후 리워드 확인
#신규 가입자는 1500 시금치(기본 1000 + 추천인 보너스 500)를 받아야 합니다.

POST {{host}}/api/auth/login
Content-Type: application/json

{
  "email": "test3@pp.com",
  "password": "qwer@123"
}

> {%
    if (response.status === 200) {
        client.global.set("auth_token_new", response.body.data.accessToken);
    }
%}

GET {{host}}/api/users/me
Authorization: Bearer {{auth_token_new}}

###1-4. 추천인 리워드 확인
#추천인(test2@pp.com)도 500 시금치를 받았는지 확인합니다.

GET {{host}}/api/users/me
Authorization: Bearer {{auth_token}}

###1-5. 추천인 코드 오류 테스트 - 유효하지 않은 코드 (실패 케이스)
#존재하지 않는 추천인 코드 입력 시 에러가 발생해야 합니다.

POST {{host}}/api/auth/sms/send
Content-Type: application/json

{
  "phoneNumber": "01022222222"
}

POST {{host}}/api/auth/sms/verify
Content-Type: application/json

{
  "phoneNumber": "01022222222",
  "code": "인증번호_입력"
}

POST {{host}}/api/auth/signup
Content-Type: application/json

{
"email": "test4@pp.com",
"password": "qwer@123",
"nickname": "잘못된코드테스트",
"phoneNumber": "01022222222",
"phoneNumberCollectionConsent": true,
"referralCode": "INVALID99"
}

###1-6. 추천인 코드 오류 테스트 - 자기 자신의 코드 (실패 케이스)
#자기 자신의 추천 코드를 입력하면 에러가 발생해야 합니다.

POST {{host}}/api/auth/sms/send
Content-Type: application/json

{
  "phoneNumber": "01033333333"
}

POST {{host}}/api/auth/sms/verify
Content-Type: application/json

{
  "phoneNumber": "01033333333",
  "code": "인증번호_입력"
}

POST {{host}}/api/auth/signup
Content-Type: application/json

{
"email": "test5@pp.com",
"password": "qwer@123",
"nickname": "자기코드테스트",
"phoneNumber": "01033333333",
"phoneNumberCollectionConsent": true
}

#가입 후 자신의 추천 코드 확인
POST {{host}}/api/auth/login
Content-Type: application/json

{
  "email": "test5@pp.com",
  "password": "qwer@123"
}

> {%
    if (response.status === 200) {
        client.global.set("auth_token_self", response.body.data.accessToken);
    }
%}

GET {{host}}/api/users/me
Authorization: Bearer {{auth_token_self}}

#자기 자신의 추천 코드로 재가입 시도 (실패해야 함)
POST {{host}}/api/auth/sms/send
Content-Type: application/json

{
  "phoneNumber": "01044444444"
}

POST {{host}}/api/auth/sms/verify
Content-Type: application/json

{
  "phoneNumber": "01044444444",
  "code": "인증번호_입력"
}

POST {{host}}/api/auth/signup
Content-Type: application/json

{
"email": "test6@pp.com",
"password": "qwer@123",
"nickname": "자기코드재시도",
"phoneNumber": "01044444444",
"phoneNumberCollectionConsent": true,
"referralCode": "위에서_확인한_자신의_추천코드"
}

###2. 로그인 (U-02)
#로그인 후 발급된 토큰을 전역 변수(auth_token)에 저장합니다.

POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "email": "test2@pp.com",
  "password": "qwer@123"
}

> {%
    // 응답 바디의 구조에 따라 경로를 정확히 지정해야 합니다.
    // 현재 구조: { "status": "success", "data": { "accessToken": "...", "tokenType": "Bearer" } }
    if (response.status === 200) {
        client.global.set("auth_token", response.body.data.accessToken);
        client.log("토큰이 성공적으로 저장되었습니다: " + client.global.get("auth_token"));
    }
%}

###3. 내 프로필 조회 (U-04)
#추천 코드(8자리), 시금치(1000), 별사탕(0)이 나오는지 확인합니다.

GET {{host}}/api/users/me
Authorization: Bearer {{auth_token}}

###4. 프로필 정보 수정 (U-04)
#닉네임과 프로필 이미지를 변경합니다.

PATCH {{host}}/api/users/me
Authorization: Bearer {{auth_token}}
Content-Type: application/json

{
"nickname": "토메이뤄",
"profileImageUrl": "https://www.google.com/search?q=https://popeye.com/profiles/olive.png"
}

###5. 수정 결과 확인 (U-04)

###닉네임이 변경되었는지, 추천 코드는 그대로 유지되는지 확인합니다.

GET {{host}}/api/users/me
Authorization: Bearer {{auth_token}}

###6. 닉네임 중복 체크 테스트
###이미 사용 중인 닉네임('멋진올리브')으로 변경 시도 시 에러가 나야 합니다.

PATCH {{host}}/api/users/me
Authorization: Bearer {{auth_token}}
Content-Type: application/json

{
"nickname": "멋진올리브"
}

###7. 크리에이터 승격 요청 (U-03)
###Role이 CREATOR로 바뀌고 creators 테이블에 레코드가 생깁니다.

PATCH {{host}}/api/users/me/creator
Authorization: Bearer {{auth_token}}

###8. 승격 후 최종 상태 확인
###Role이 ROLE_CREATOR로 변경되었는지 확인합니다.

GET {{host}}/api/users/me
Authorization: Bearer {{auth_token}}

###9. 크리에이터 정산 정보 업데이트 (U-08)
#실명, 은행명, 계좌번호를 입력하여 정산 정보를 업데이트합니다.(계좌번호는 AES-256 암호화)

PATCH {{host}}/api/users/me/settlement
Authorization: Bearer {{auth_token}}
Content-Type: application/json

{
  "realName": "홍길동",
  "bank_name": "신한은행",
  "account": "110-123-456789"
}

###10. 정산 정보 업데이트 후 확인
#DB에서 계좌번호가 암호화되어 저장되었는지 확인합니다.(실제 DB 조회는 별도로 확인 필요)

###===================U-02 본인 인증 오류 테스트
###11. 본인 인증 없이 회원가입 시도 (실패 케이스)
#본인 인증을 완료하지 않고 회원가입을 시도하면 에러가 발생해야 합니다.

POST {{host}}/api/auth/signup
Content-Type: application/json

{
"email": "test3@pp.com",
"password": "qwer@123",
"nickname": "테스트유저",
"phoneNumber": "01099999999",
"phoneNumberCollectionConsent": true
}


###12. 잘못된 인증번호 입력 (실패 케이스)
#잘못된 인증번호를 입력하면 에러가 발생해야 합니다.

POST {{host}}/api/auth/sms/send
Content-Type: application/json

{
  "phoneNumber": "01088888888"
}

POST {{host}}/api/auth/sms/verify
Content-Type: application/json

{
  "phoneNumber": "01088888888",
  "code": "999999"
}

###13. 만료된 인증번호 검증 (실패 케이스)
#3분이 지난 후 인증번호를 검증하면 에러가 발생해야 합니다.
#(실제로는 3분 이상 기다려야 하므로, Redis에서 직접 키를 삭제하거나 시간을 기다려야 함)

###===================U-06 비밀번호 찾기 테스트
###14. 비밀번호 재설정 요청 (U-06)
#이메일로 비밀번호 재설정 링크를 발송합니다.
#이메일 서비스가 설정되어 있어야 정상 작동합니다.
#(테스트 환경에서는 이메일이 실제로 발송되지 않을 수 있으므로 로그 확인)

POST {{host}}/api/auth/password/reset
Content-Type: application/json

{
  "email": "test2@pp.com"
}

###15. 비밀번호 재설정 처리 (U-06)
#14번 요청 후 이메일에서 받은 토큰을 사용하여 비밀번호를 재설정합니다.
#토큰은 이메일 링크에서 확인하거나, Redis에서 직접 확인할 수 있습니다.
#주의: 실제 이메일 발송이 안 되는 경우, Redis에서 토큰을 직접 확인해야 합니다.

POST {{host}}/api/auth/password/reset/confirm
Content-Type: application/json

{
  "token": "여기에_이메일에서_받은_토큰_입력",
  "newPassword": "newPass@123"
}

###16. 재설정된 비밀번호로 로그인 테스트 (U-06)
#15번에서 재설정한 비밀번호로 로그인이 가능한지 확인합니다.

POST {{host}}/api/auth/login
Content-Type: application/json

{
  "email": "test2@pp.com",
  "password": "newPass@123"
}

###17. 비밀번호 재설정 오류 테스트 - 잘못된 이메일 (실패 케이스)
#존재하지 않는 이메일로 재설정 요청 시 에러가 발생해야 합니다.

POST {{host}}/api/auth/password/reset
Content-Type: application/json

{
  "email": "nonexistent@example.com"
}

###18. 비밀번호 재설정 오류 테스트 - 만료된 토큰 (실패 케이스)
#30분이 지난 토큰으로 재설정 시도 시 에러가 발생해야 합니다.
#(실제로는 30분 이상 기다려야 하므로, Redis에서 직접 키를 삭제하거나 시간을 기다려야 함)

###===================U-09 회원 탈퇴 테스트
###19. 회원 탈퇴 (U-09)
#회원 탈퇴를 요청합니다. Soft Delete 방식으로 deletedAt에 탈퇴 일시가 기록됩니다.

DELETE {{host}}/api/users/me
Authorization: Bearer {{auth_token}}

###20. 탈퇴 후 로그인 시도 (실패 케이스)
#탈퇴한 계정으로 로그인 시도 시 에러가 발생해야 합니다.

POST {{host}}/api/auth/login
Content-Type: application/json

{
  "email": "test2@pp.com",
  "password": "qwer@123"
}

###21. 탈퇴한 계정으로 재가입 시도 - 30일 이내 (실패 케이스)
#탈퇴 후 30일 이내에 재가입 시도 시 에러가 발생해야 합니다.
#주의: 실제로는 30일을 기다려야 하므로, 테스트 시 DB에서 deletedAt 날짜를 수정하거나 시간을 기다려야 합니다.

POST {{host}}/api/auth/sms/send
Content-Type: application/json

{
  "phoneNumber": "01012345677"
}

POST {{host}}/api/auth/sms/verify
Content-Type: application/json

{
  "phoneNumber": "01012345677",
  "code": "인증번호_입력"
}

POST {{host}}/api/auth/signup
Content-Type: application/json

{
"email": "test2@pp.com",
"password": "qwer@123",
"nickname": "재가입시도",
"phoneNumber": "01012345677",
"phoneNumberCollectionConsent": true
}